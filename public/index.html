<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WPlace Snapshot Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <style>#map { width:100vw; height:100vh; }</style>
</head>
<body>
  <div id="leaflet-map" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:0;"></div>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>


  <link
    href="https://unpkg.com/maplibre-gl@2.2.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@2.2.1/dist/maplibre-gl.js"></script>

  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.20/leaflet-maplibre-gl.js"></script>


  <script>
    const TILE_SIZE    = 1000;
    const NATIVE_ZOOM  = 16;

    const TILES_X = 2048;
    const TILES_Y = 2048;

    const map = L.map('leaflet-map', {
      maxBounds: [[180, -Infinity], [-180, Infinity]],
      maxBoundsViscosity: 1,  
      minZoom: 1
    })

    const savedState = localStorage.getItem('mapState');
    if (savedState) {
      const state = JSON.parse(savedState);
      map.setView([state.lat, state.lng], state.zoom);
    } else {
      map.setView([0, 0], 0);
    }

    L.tileLayer('http://127.0.0.1:3000/tiles/{z}/{x}/{y}.png', {
      tileSize: 512,
      maxNativeZoom: 12,
      maxZoom: 16,
      minZoom: 6,
      noWrap: true
    }).addTo(map);

    const tileX = 1231;
    const tileY = 694;

    const point = L.point(tileX, tileY);
    const latlng = map.unproject(point, map.getZoom());

    L.marker(latlng).addTo(map);

    var gl = L.maplibreGL({
      style: 'https://demotiles.maplibre.org/style.json',
    }).addTo(map);

    map.on('moveend zoomend', () => {
      const center = map.getCenter();
      const zoom = map.getZoom();
      localStorage.setItem('mapState', JSON.stringify({
        lat: center.lat,
        lng: center.lng,
        zoom: zoom
      }));
    });
  </script>
</body>
</html>